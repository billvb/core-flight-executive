/*
 *  Copyright (c) 2004-2014, United States government as represented by the
 *  administrator of the National Aeronautics Space Administration.
 *  All rights reserved. This software was created at NASA Glenn
 *  Research Center pursuant to government contracts.
 *
 *  This is governed by the NASA Open Source Agreement and may be used,
 *  distributed and modified only according to the terms of that agreement.
 */

/**
 * \file target_config.c
 *
 *  Created on: Dec 3, 2013
 *  Created by: joseph.p.hickey@nasa.gov
 *
 * Defines constant configuration structures and pointers that link together
 * the CFE core, PSP, OSAL.  The content of these configuration structures
 * can be used to avoid directly using #include to reference a function
 * implemented in another library, which can greatly simplify include paths
 * and create a more modular build.
 *
 */

#include "target_config.h"
#include "cfe_mission_cfg.h"
#include "cfe_platform_cfg.h"
#include "cfe_es.h"
#include "cfe_time.h"
#include "cmake_version.h"
#include "build.h"


#ifndef CFE_CPU_NAME_VALUE
#define CFE_CPU_NAME_VALUE          "unknown"
#endif

#ifndef CFE_CPU_ID_VALUE
#define CFE_CPU_ID_VALUE            0
#endif

#ifndef CFE_SPACECRAFT_ID_VALUE
#define CFE_SPACECRAFT_ID_VALUE     0x42
#endif


Target_CfeConfigData GLOBAL_CFE_CONFIGDATA =
{
      /*
       * Entry points to CFE code called by the PSP
       */
      .System1HzISR = CFE_TIME_Local1HzISR,
      .SystemMain = CFE_ES_Main,
      .SystemExceptionISR = CFE_ES_ProcessCoreException,

      /*
       * Default values for Startup file.
       * This is a suggested value, but the PSP may provide a different file
       */
      .NonvolStartupFile = CFE_ES_NONVOL_STARTUP_FILE,

      /*
       * Sizes of other memory segments
       */
      .CdsSize = CFE_ES_CDS_SIZE,
      .ResetAreaSize = CFE_ES_RESET_AREA_SIZE,
      .UserReservedSize = CFE_ES_USER_RESERVED_SIZE,

      .RamDiskSectorSize = CFE_ES_RAM_DISK_SECTOR_SIZE,
      .RamDiskTotalSectors = CFE_ES_RAM_DISK_NUM_SECTORS
};

/*
 * PSP Static Module load section
 *
 * This is in here (the target-specific file) rather than the PSP config data structure
 * because it can be different for different targets even those that share the same basic PSP.
 *
 * For instance, if two boards use the same basic HW hardware but one of them has a special
 * timer interrupt for synchronization, only this second target would include a PSP module
 * to bind to that special interrupt.
 *
 * In order to reference the driver from a dynamically generated set,
 * two inclusions of the same file are done using different definitions
 * of the LOAD_PSP_MODULE() macro.  The first pass creates "extern" references
 * to the API objects, the second pass generates a table of pointers to them.
 */

/*
 * Definition of LOAD_*_MODULE for the first pass, creates an extern declaration
 * for the API object which must be named appropriately.
 */
#define LOAD_PSP_MODULE(name)   extern CFE_StaticModuleApi_t CFE_PSP_##name##_API;
#define LOAD_CFS_MODULE(name)   extern CFE_StaticModuleApi_t CFS_##name##_API;
#include "psp_module_list.inc"
#include "cfs_module_list.inc"
#undef LOAD_PSP_MODULE
#undef LOAD_CFS_MODULE

/*
 * Definition of LOAD_PSP_MODULE for the second pass, creates an entry with
 * the name and a pointer to the API object.
 *
 * This is done here in the target file and NOT in the PSP because it is
 * configured specifically to each target.  The contents of the "psp_module_list.inc"
 * file are generated by the build scripts and are different for each target.
 */
#define LOAD_PSP_MODULE(name)   { .Name = #name, .Api = &CFE_PSP_##name##_API },
static CFE_StaticModuleLoadEntry_t GLOBAL_PSP_MODULELIST[] =
{
#include "psp_module_list.inc"
    { .Name = NULL }
};
#undef LOAD_PSP_MODULE

/**
 * Instantiation of the CFE static module list
 */
#define LOAD_CFS_MODULE(name)   { .Name = #name, .Api = &CFS_##name##_API },
static CFE_StaticModuleLoadEntry_t GLOBAL_CFS_MODULELIST[] =
{
#include "cfs_module_list.inc"
    { .Name = NULL }
};

#undef LOAD_CFS_MODULE


/**
 * Instantiation of global system-wide configuration struct
 * This contains build info plus pointers to the PSP and CFE
 * configuration structures.  Everything will be linked together
 * in the final executable.
 */
Target_ConfigData GLOBAL_CONFIGDATA =
{
        .MissionVersion = MISSION_VERSION,
        .CfeVersion = CFE_VERSION,
        .OsalVersion = OSAL_VERSION,
        .Config = MISSION_CONFIG,
        .Date = MISSION_BUILDDATE,
        .User = MISSION_BUILDUSER "@" MISSION_BUILDHOST,
        .Default_CpuName = CFE_CPU_NAME_VALUE,
        .Default_CpuId = CFE_CPU_ID_VALUE,
        .Default_SpacecraftId = CFE_SPACECRAFT_ID_VALUE,
        .CfeConfig = &GLOBAL_CFE_CONFIGDATA,
        .PspConfig = &GLOBAL_PSP_CONFIGDATA,
        .PspModuleList = GLOBAL_PSP_MODULELIST,
        .CfsModuleList = GLOBAL_CFS_MODULELIST
};



/*
 * Instantiate a list of symbols that should be linked into the final executable
 * This ensures that it will be available for dynamically loaded apps to use even if
 * it is not referenced within CFE itself
 */
typedef void (*CFE_GlobalApiFunc_t)(void);
#define EXPORT_SYMBOL(x)    extern void x (void);
#include "export_symbols.inc"
#undef  EXPORT_SYMBOL
#define EXPORT_SYMBOL(x)    (x),
CFE_GlobalApiFunc_t GLOBAL_REF_SYMTAB[] =
{
#include "export_symbols.inc"
        (CFE_GlobalApiFunc_t)NULL  /* End of list marker */
};
#undef  EXPORT_SYMBOL
